@page "/register/{TripId:int}"
@using System.Net.Http.Json
@using CyclingTripManagement.Models
@inject HttpClient Http
@inject NavigationManager Navigation

<PageTitle>Register for Trip</PageTitle>

<div class="container mt-4">
    <h1>Trip Registration</h1>

    @if (trip == null)
    {
        <p><em>Loading trip information...</em></p>
    }
    else
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h3>Register for: @trip.Name</h3>
                    </div>
                    <div class="card-body">
                        @if (showSuccess)
                        {
                            <div class="alert alert-success">
                                <h4>Registration Successful!</h4>
                                <p>Thank you for registering. We'll contact you shortly at @participant.Email to confirm your booking.</p>
                                <button class="btn btn-primary" @onclick="GoToHome">
                                    Return to Home
                                </button>
                            </div>
                        }
                        else
                        {
                            <EditForm Model="participant" OnValidSubmit="HandleRegistration">
                                <DataAnnotationsValidator />
                                <ValidationSummary class="text-danger" />

                                @if (!string.IsNullOrEmpty(errorMessage))
                                {
                                    <div class="alert alert-danger">@errorMessage</div>
                                }

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">First Name *</label>
                                        <InputText class="form-control" @bind-Value="participant.FirstName" />
                                        <ValidationMessage For="@(() => participant.FirstName)" />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Last Name *</label>
                                        <InputText class="form-control" @bind-Value="participant.LastName" />
                                        <ValidationMessage For="@(() => participant.LastName)" />
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Email Address *</label>
                                    <InputText type="email" class="form-control" @bind-Value="participant.Email" />
                                    <ValidationMessage For="@(() => participant.Email)" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Phone Number *</label>
                                    <InputText class="form-control" @bind-Value="participant.PhoneNumber" />
                                    <ValidationMessage For="@(() => participant.PhoneNumber)" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Date of Birth *</label>
                                    <InputDate class="form-control" @bind-Value="participant.Birthday" />
                                    <ValidationMessage For="@(() => participant.Birthday)" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Strava Account Link (optional)</label>
                                    <InputText class="form-control" @bind-Value="participant.StravaAccountLink" 
                                             placeholder="https://www.strava.com/athletes/..." />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Special Dietary Requirements (optional)</label>
                                    <InputTextArea class="form-control" rows="3" @bind-Value="participant.SpecialDiets" 
                                                 placeholder="Please list any allergies or dietary restrictions..." />
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input" @bind-Value="singleRoomRequested" id="singleRoom" />
                                        <label class="form-check-label" for="singleRoom">
                                            I would like a single room (+ €@trip.SingleRoomSupplement)
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input" @bind-Value="termsAccepted" id="terms" />
                                        <label class="form-check-label" for="terms">
                                            I accept the terms and conditions *
                                        </label>
                                    </div>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg" disabled="@(!termsAccepted || isSubmitting)">
                                        @if (isSubmitting)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                            <text>Processing...</text>
                                        }
                                        else
                                        {
                                            <text>Complete Registration</text>
                                        }
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" @onclick="CancelRegistration">
                                        Cancel
                                    </button>
                                </div>
                            </EditForm>
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">Registration Summary</h4>
                    </div>
                    <div class="card-body">
                        <h5>@trip.Name</h5>
                        <p class="text-muted">@trip.Location</p>
                        <hr />
                        <div class="d-flex justify-content-between">
                            <span>Base Price:</span>
                            <strong>€@trip.BasePrice</strong>
                        </div>
                        @if (singleRoomRequested)
                        {
                            <div class="d-flex justify-content-between">
                                <span>Single Room:</span>
                                <strong>€@trip.SingleRoomSupplement</strong>
                            </div>
                            <hr />
                            <div class="d-flex justify-content-between">
                                <span><strong>Total:</strong></span>
                                <strong class="text-primary">€@(trip.BasePrice + trip.SingleRoomSupplement)</strong>
                            </div>
                        }
                        else
                        {
                            <hr />
                            <div class="d-flex justify-content-between">
                                <span><strong>Total:</strong></span>
                                <strong class="text-primary">€@trip.BasePrice</strong>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int TripId { get; set; }

    private Trip? trip;
    private Participant participant = new Participant();
    private bool singleRoomRequested = false;
    private bool termsAccepted = false;
    private bool showSuccess = false;
    private bool isSubmitting = false;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            trip = await Http.GetFromJsonAsync<Trip>($"api/trips/{TripId}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading trip: {ex.Message}");
        }
    }

    private async Task HandleRegistration()
    {
        if (trip == null) return;

        isSubmitting = true;
        errorMessage = string.Empty;

        try
        {
            // First, create the participant
            participant.SingleRoomRequest = singleRoomRequested;
            var participantResponse = await Http.PostAsJsonAsync("api/participants", participant);
            
            if (!participantResponse.IsSuccessStatusCode)
            {
                errorMessage = "Failed to create participant record. Please try again.";
                isSubmitting = false;
                return;
            }

            var createdParticipant = await participantResponse.Content.ReadFromJsonAsync<Participant>();
            
            if (createdParticipant == null)
            {
                errorMessage = "Failed to process registration. Please try again.";
                isSubmitting = false;
                return;
            }

            // Then create the registration
            var registration = new TripRegistration
            {
                TripId = TripId,
                ParticipantId = createdParticipant.Id,
                SingleRoomRequested = singleRoomRequested,
                RegistrationDate = DateTime.UtcNow
            };

            var registrationResponse = await Http.PostAsJsonAsync("api/registrations", registration);
            
            if (registrationResponse.IsSuccessStatusCode)
            {
                showSuccess = true;
            }
            else
            {
                var error = await registrationResponse.Content.ReadAsStringAsync();
                errorMessage = $"Registration failed: {error}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
            Console.WriteLine($"Registration error: {ex}");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void GoToHome()
    {
        Navigation.NavigateTo("/");
    }

    private void CancelRegistration()
    {
        Navigation.NavigateTo($"/trip/{TripId}");
    }
}
